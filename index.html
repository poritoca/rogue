<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" name="viewport"/>
<title>ASCII Roguelike 999F — 整頓保持＆デコイ＆FX</title>
<style>
:root{
  --bg:#0b0d10; --panel:#10141a; --panel2:#121821; --fg:#e9eef3; --dim:#a7b4be; --line:#1d2530;
  --accent:#0f2a23; --accent2:#134a3a; --good:#c8ffee; --warn:#ffdb9d; --hl:#78e3ff;
  --green:#8bffc9;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:rgba(0,0,0,0)!important;}
html,body{height:100%}
html, body { margin:0; background:#0b0d10; color:var(--fg);
  font-family:ui-monospace,Menlo,Consolas,monospace;
  overflow:hidden; height:100svh;
  touch-action: manipulation;
}
.btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#141b23;color:#e9f3ff;user-select:none;cursor:pointer;font-size:13px;line-height:1}
.btn:active{filter:brightness(1.1)}
#title{display:flex;align-items:center;justify-content:center;height:100svh;padding:10px}
.titleCard{width:min(720px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
.row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
.dim{color:var(--dim)}
#game{display:none;padding:6px;height:100svh;max-width:980px;margin:0 auto;gap:6px}
.top{display:flex;align-items:center;justify-content:space-between;gap:6px}
.chip{padding:4px 8px;border-radius:999px;background:#111923;border:1px solid #1f2c3b;color:#cfe4ff;font-size:11px}
#viewport,#fullMap{
  white-space:pre;
  font-family:ui-monospace,Menlo,Consolas,monospace;
  font-size:20px; line-height:1.0; letter-spacing:0;
  background:var(--panel2); border:1px solid var(--line); border-radius:10px; padding:6px;
  user-select:none; -webkit-user-select:none; outline:none; box-shadow:none; -webkit-tap-highlight-color:transparent;
}
#viewport *{pointer-events:none}
.bottom{display:flex;gap:6px;min-height:0;flex:1 1 auto;overflow:hidden}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:8px}
#controls{width:44%;display:flex;flex-direction:column;gap:6px}
#stats{width:56%;white-space:pre-wrap;overflow:auto;line-height:1.2;font-size:13px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.grid3x3{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.pad,.act{padding:8px 0;border-radius:8px;border:1px solid #1f2833;background:#12171e;text-align:center;font-size:16px;line-height:1}
.act.accent{background:var(--accent);border-color:var(--accent2);color:var(--good)}
@media(max-width:760px){
  #viewport{font-size:18px}
  .bottom{flex-direction:column}
  #controls,#stats{width:100%}
  .pad,.act{font-size:15px;padding:8px 0}
  #stats{font-size:12px}
}
/* トースト（ログ）：少し大きく＆上から下げる＋フェード */
#toast{
  position:fixed;inset:0;pointer-events:none;
  display:flex;flex-direction:column;align-items:center;gap:8px;
  padding-top:12vh; /* ↓ 少し下げる */
  z-index:80;
}
.toast{
  background:rgba(8,12,16,.78);color:#fff;border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;border-radius:12px;font-size:16px;
  backdrop-filter:blur(6px);
  box-shadow:0 8px 24px rgba(0,0,0,.35);
  transform:translateY(0);opacity:1;
  transition:opacity .28s ease, transform .28s ease;
}
.toast.toast-green{ color:var(--green); border-color:rgba(140,255,210,.3); }
.overlay{display:none;position:fixed;inset:0;z-index:70;background:rgba(0,0,0,.66);backdrop-filter:blur(8px);align-items:center;justify-content:center}
.modal{width:min(92vw,780px);max-height:84vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px}
.list{display:grid;grid-template-columns:1fr;gap:6px}
.item{padding:10px;border:1px solid #22303b;border-radius:10px;background:linear-gradient(180deg,#151b22,#0f151b);cursor:pointer;font-size:14px;position:relative}
.item.flash::after{content:"";position:absolute;inset:0;border-radius:10px;box-shadow:0 0 0 0 rgba(120,227,255,.9);animation:flash 1.2s ease-out 1}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(120,227,255,1)}100%{box-shadow:0 0 0 24px rgba(120,227,255,0)}}
.pill{padding:8px 10px;border-radius:999px;border:1px solid #20303d;background:#131a21;cursor:pointer}
.shake{animation:shake .18s}
@keyframes shake{0%{transform:translate(0,0)}33%{transform:translate(-2px,0)}66%{transform:translate(2px,0)}100%{transform:translate(0,0)}}
#lowHP{position:fixed;inset:0;pointer-events:none;background:radial-gradient(circle at 50% 50%, rgba(255,0,0,0.0), rgba(255,0,0,0.14) 60%, rgba(255,0,0,0.22) 100%);opacity:0;transition:opacity .15s;z-index:55}

/* ダブルタップズーム/ピンチ対策 */
button, .pad, .act, .btn { touch-action: manipulation; }

/* 範囲プレビュー */
#rangeOL .modal{font-size:14px}
.rangeBox{white-space:pre;background:#0f151b;border:1px solid #1e2a35;border-radius:10px;padding:8px}
.rangeLegend{display:flex;gap:8px;align-items:center;margin-top:6px}
.legend{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:4px}
.l-me{background:#79ffb5}.l-hit{background:#ffd27a}.l-blast{background:#ff8b8b}.l-line{background:#8bd1ff}

/* ==== Inv Tabs（所持品内のみ） ==== */
.tabs {
  display:grid;
  grid-template-columns: repeat(4, 1fr); /* 2段構成 */
  gap:6px;
  margin:6px 0;
}
.tab { text-align:center; padding:6px 0; border:1px solid #22303b; border-radius:999px;
  background:#12171e; color:#cfe4ff; font-size:13px; cursor:pointer; user-select:none; }
.tab.active { background:var(--accent); border-color:var(--accent2); color:var(--good); }
.tabs + .list { margin-top:4px; }

/* ---- 画面全体FX（キャラ位置に依存しない） ---- */
#fx { position:fixed; inset:0; pointer-events:none; z-index:85; overflow:hidden; }
.fx { position:absolute; inset:0; }

/* 斬撃：画面横断の多重スラッシュ */
.fx-slash{
  --dur:.55s;
  background:
    radial-gradient(120% 120% at 0% 100%, rgba(255,255,255,.18), rgba(255,255,255,0) 70%),
    linear-gradient(115deg, rgba(255,255,255,0) 35%, rgba(255,255,255,.85) 50%, rgba(255,255,255,0) 65%),
    linear-gradient(115deg, rgba(255,255,255,0) 45%, rgba(255,240,190,.6) 50%, rgba(255,255,255,0) 55%);
  mix-blend-mode: screen;
  transform: translateX(-120%) skewY(-10deg);
  animation: slashSweep var(--dur) ease-out forwards;
}
.fx-slash::after, .fx-slash::before{
  content:""; position:absolute; inset:0; mix-blend-mode:screen; pointer-events:none;
}
.fx-slash::before{
  background: linear-gradient(115deg, rgba(255,255,255,0) 40%, rgba(200,255,250,.5) 50%, rgba(255,255,255,0) 60%);
  transform: translateX(-10%) skewY(-8deg);
}
.fx-slash::after{
  background: linear-gradient(115deg, rgba(255,255,255,0) 42%, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 58%);
  filter: blur(2px);
}
@keyframes slashSweep{
  0%{ transform:translateX(-120%) skewY(-10deg); opacity:0 }
  20%{ opacity:1 }
  100%{ transform:translateX(20%) skewY(-10deg); opacity:0 }
}

/* 入手：豪華スパーク＋微細パーティクル */
.fx-spark{
  --dur:.7s;
  background:
    radial-gradient(closest-side, rgba(140,255,230,.25), rgba(140,255,230,0) 60%),
    radial-gradient(closest-side, rgba(255,245,200,.22), rgba(255,245,200,0) 55%);
  mix-blend-mode:screen;
  animation:sparkFade var(--dur) ease-out forwards;
}
@keyframes sparkFade{ 0%{opacity:0} 20%{opacity:1} 100%{opacity:0} }
/* パーティクル */
.spark-dot{ position:absolute; width:4px;height:4px;border-radius:50%;
  background: radial-gradient(circle, #fff, rgba(255,255,255,.2));
  mix-blend-mode:screen; animation:sparkDrift .9s ease-out forwards; }
@keyframes sparkDrift{
  0%{ transform:translate(var(--x), var(--y)) scale(.6); opacity:0 }
  20%{ opacity:1 }
  100%{ transform:translate(calc(var(--x) + var(--dx)), calc(var(--y) + var(--dy))) scale(.8); opacity:0 }
}

/* 階段：妖しい紫の波 */
.fx-omin{
  --dur:.8s;
  background:
    radial-gradient(120% 120% at 50% 55%, rgba(168,120,255,.28), rgba(168,120,255,0) 60%),
    radial-gradient(100% 100% at 50% 45%, rgba(80,20,140,.2), rgba(80,20,140,0) 50%);
  mix-blend-mode:screen;
  animation:ominWave var(--dur) ease-out forwards;
}
@keyframes ominWave{
  0%{ opacity:0; transform:scale(.95) }
  30%{ opacity:.95 }
  100%{ opacity:0; transform:scale(1.08) }
}
</style>
</head>
<body>
<div id="lowHP"></div>
<div id="toast"></div>
<div id="fx"></div>
<!-- タイトル -->
<div id="title">
<div class="titleCard">
<div style="font-weight:800;font-size:20px">ASCII ローグライク 999F — 整頓保持＆デコイ＆FX</div>
<div class="dim" id="bestInfo" style="margin:6px 0 10px">過去の最高到達: - / スコア: -</div>
<div class="row">
<div class="btn" id="btnNew">新しく始める</div>
<div class="btn" id="btnLocal">ローカルセーブから続き</div>
<div class="btn" id="btnCode">テキストセーブから続き</div>
</div>
</div>
</div>
<!-- ゲーム -->
<div id="game">
<div class="top">
<div class="chip" id="chipBest">Best 0F / Score 0</div>
<div class="row" style="gap:6px">
<div class="btn" id="btnPickupMode">自動拾い：ON</div>
<div class="btn" id="btnMap">マップ</div>
<div class="btn" id="btnTitle">タイトル</div>
</div>
</div>
<div id="mapWrap"><pre aria-label="マップ" id="viewport"></pre></div>
<div class="bottom">
<div class="panel" id="controls">
<div class="dim" style="font-size:12px">移動（長押しで連続）※斜め対応</div>
<!-- 斜めD-pad -->
<div class="grid3x3">
<div class="pad" data-hold="upleft">↖</div>
<div class="pad" data-hold="up">↑</div>
<div class="pad" data-hold="upright">↗</div>
<div class="pad" data-hold="left">←</div>
<div class="pad" data-act="wait">待機</div>
<div class="pad" data-hold="right">→</div>
<div class="pad" data-hold="downleft">↙</div>
<div class="pad" data-hold="down">↓</div>
<div class="pad" data-hold="downright">↘</div>
</div>
<div class="dim" style="margin-top:4px;font-size:12px">アクション</div>
<div class="grid3">
<div class="act accent" data-act="inv">所持品</div>
<div class="act" data-act="descend">降りる</div>
<div class="act" data-act="shoot">撃つ</div>
<div class="act" data-act="save">セーブ</div>
<div class="act" data-act="code">コード</div>
</div>
</div>
<div class="panel" id="stats"></div>
</div>
</div>
<!-- 全体マップ -->
<div class="overlay" id="mapOL">
<div class="modal">
<div class="row" style="justify-content:space-between">
<div class="dim">全体図（未踏は#）</div>
<div class="btn" id="btnCloseMap">閉じる</div>
</div>
<pre id="fullMap"></pre>
</div>
</div>
<!-- 所持品 -->
<div class="overlay" id="invOL">
<div class="modal">
<div class="row" style="justify-content:space-between">
<div class="dim">所持品（タップでメニュー）</div>
<div class="row">
<div class="btn invSortToggle">整頓：OFF（有効）</div>
<div class="btn" id="btnCloseInv">閉じる</div>
</div>
</div>
<!-- ※ tabs は openInv() で毎回初期化生成 -->
<div id="invTabsHost"></div>
<div class="list" id="invList"></div>
</div>
</div>
<!-- アイテムメニュー -->
<div class="overlay" id="menuOL">
<div class="modal">
<div class="dim" id="menuTitle">アイテム</div>
<div class="dim" id="menuDesc" style="margin-top:6px"></div>
<div class="rangeBox" id="menuRange" style="display:none;margin-top:6px"></div>
<div class="row" id="menuBtns" style="margin-top:8px"></div>
<div class="row" style="justify-content:flex-end;margin-top:10px"><div class="btn" id="btnCloseMenu">閉じる</div></div>
</div>
</div>
<!-- 壺 -->
<div class="overlay" id="potOL">
<div class="modal">
<div class="row" style="justify-content:space-between">
<div class="dim" id="potTitle">保存の壺</div>
<div class="btn" id="btnClosePot">閉じる</div>
</div>
<div class="dim">入れる（タップで追加）</div>
<div class="list" id="potAdd"></div>
<div class="dim" style="margin-top:8px">取り出す（タップで取り出し）</div>
<div class="list" id="potTake"></div>
</div>
</div>
<!-- 範囲プレビュー -->
<div class="overlay" id="rangeOL">
<div class="modal">
<div class="row" style="justify-content:space-between">
<div class="dim">効果範囲プレビュー</div>
<div class="btn" id="btnCloseRange">閉じる</div>
</div>
<div class="rangeBox" id="rangeAscii"></div>
<div class="rangeLegend">
<span class="legend l-me"></span><span class="dim">自分</span>
<span class="legend l-hit"></span><span class="dim">効果範囲</span>
<span class="legend l-blast"></span><span class="dim">爆発範囲</span>
<span class="legend l-line"></span><span class="dim">直線</span>
</div>
</div>
</div>

<script src="./app.js"></script>
<!-- 会計ダイアログ（ショップ） -->
<div id="shopDialog" class="overlay" style="display:none">
  <div class="modal">
    <div style="font-weight:700;margin-bottom:6px">お会計</div>
    <div id="shopDialogText" class="dim" style="margin-bottom:10px">
      未払いアイテムの一覧と合計を表示します…
    </div>
    <div id="shopBillList" class="list" style="max-height:40vh;overflow:auto;margin-bottom:10px"></div>
    <div class="row" style="align-items:center;justify-content:space-between;margin-top:4px">
      <div class="dim" id="shopMoney">所持金: 0G</div>
      <div class="row" style="gap:8px">
        <div class="btn" id="btnRefuse">支払わない</div>
        <div class="btn" id="btnPay">支払う</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
